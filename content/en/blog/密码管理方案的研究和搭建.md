---
title: 密码管理方案的研究和搭建
encrypt: true
enc_pwd: askding
categories:
  - Tools
date: 2022-05-18 10:43:40
top:
tags:
layout:
referer: https://plutotree.me/bitwarden/2020/03/01/bitwarden.html
---
编写进度
- [x] 


### 身份认证有三个方式：你知道的，你持有的，以及你固有的。

- 一般的口令密码之类算第一类（你知道的），如邮箱的口令密码
- 持有令牌通行证之类算第二类（你持有的），如短信验证码，OTP码
- 指纹虹膜等生物特征算第三类（你固有的）。

 由于获取／伪造的难度不同，一般认为第一类的安全性比第二类差，第二类又比第三类差；但需要明确的是，如果只有其中一种都算是弱认证，必须独立使用两种甚至三种才算是强认证。

  ### 术语介绍
- `[WebAuthn](https://flyhigher.top/develop/2160.html)` 
- `FIDO`: (Fast IDentity Online) 是一个安全、开放、防钓鱼、无密码认证标准的联盟。有三个安全协议: `UAF`、`U2F`、`FIDO2` 
- `U2F` : 是一个跨平台、浏览器直接支持、无需安装驱动、基于USB/NFC等物理设备的方案。YuBikey是实现了`U2F`标准的一种设备。
- `UAF`: FIDO推出基于指纹、虹膜、语音等生物特征方案
- `OTP` :（One-time Password)一次性密码，动态口令,如Google Authenticator， Authy， 短信验证码等
  
Bitwarden常见功能：
- [Bitwarden入门使用](https://help.ppgg.in/getting-started)
- [Bitwarden 安全白皮书](https://help.ppgg.in/business-resources/bitwarden-security-whitepaper)
- [密码库管理](https://help.ppgg.in/your-vault)
- [密码导入和导出](https://help.ppgg.in/import-export)
- [全平台密码自动填充](https://help.ppgg.in/auto-fill)
- [两步登录](https://help.ppgg.in/two-step-login)
- [支持TOTP](https://help.ppgg.in/your-vault/bitwarden-authenticator-totp)
 


# 前提条件
- x64 2C4G25GB
![](https://raw.githubusercontent.com/crkmythical/PicGo/main/images/20220521174712.png)

## 安装docker-compose
```bash
wget -qO- https://get.docker.com/ | sudo bash
sudo curl -L https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
sudo systemctl start docker  && sudo systemctl enable docker
```

## 创建目录
```shell
cd /opt && sudo mkdir vaultwarden && cd vaultwarden
pwd
# 应当输出 /home/username/bitwarden
```

## 配置文件
```bash
cat >> config.env <<EOF
SIGNUPS_ALLOWED=true
DOMAIN=https://example.com
DATABASE_URL=/data/bitwarden.db
ROCKET_WORKERS=10
WEB_VAULT_ENABLED=true
EOF
```

## 服务描述文件
```shell
cat <<EOF > /opt/vaultwarden/docker-compose.yml 
version: '3'

services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    user: 1000:1000
    restart: always
    ports:
	  - "8080:80"
	  - "3012:3012"
    volumes:
      - ./bw-data:/data
	environment:
	  - ADMIN_TOEKN=PxArb2LTe+UE70UwhIEmQ+jx7EzYtqMyBp4aOZHgIx+qbDhTS4SR6yFTEDFwuCLl
	  - DOMAIN=https://bitwarden.micorsoft.cn
	  - ROCKET_WORKERS=20
	  - SHOW_PASSWORD_HINT=false
	  - SIGNUPS_ALLOWED=false
	  - WEBSOCKET_ENABLED=true
	  - WEB_VAULT_ENABLED=true
	  - SMTP_HOST=smtp.domain.name
	  - SMTP_FROM=no-reply@domain.name
	  - SMTP_PORT=587
	  - SMTP_SSL=true
	  - SMTP_USERNAME=no-reply@domain.name
	  - SMTP_PASSWORD=password
    env_file:
      - config.env
EOF

```

## 启动/停止服务
```shell
cd /opt/vaultwarden
sudo docker-compose up -d

sudo docker-compose down
sudo docker-compose restart
```


## 更新服务端
```bash
# 进入服务配置所在目录
cd /opt/vaultwarden
# 停止服务
sudo docker-compose down
# 拉取最新镜像
sudo docker-compose pull bitwarden
# 使用最新镜像重新启动服务
docker-compose up -d bitwarden
# 清理旧的镜像文件
docker image rm $(docker image ls -f dangling=true -q)
```


# Bitwarden搭建
## 域名配置
![](https://raw.githubusercontent.com/crkmythical/PicGo/main/images/20220519172710.png)


## 证书配置
申请https证书，不得不说[acme.sh](https://github.com/acmesh-official/acme.sh)一键申请&部署证书，真的是太方便了
### 安装acme.sh
```shell
curl https://get.acme.sh | sh -s email=my@example.com   # 安装并注册
```

### 生成证书
这里选择使用standalone的方式，需要确保这个域名是未在使用的，如果默认的80端口已经被使用，还可以指定其他端口
```shell
cd .acme.sh
./acme.sh --issue --standalone -d example.com --force
```

### 拷贝证书
nginx的配置文件和证书放在 `/etc/nginx.conf/conf.d`目录下
```shell
./acme.sh --install-cert  -d subdomain.domain.com \
		--fullchain-file /etc/nginx/conf.d/subdomain.domain.com.crt \
		--key-file /etc/nginx/conf.d/subdomain.domain.com.key   \
		--reloadcmd "systemctl restart nginx" 
```


## 部署Bitwarden服务
	由于官方的服务需要用到sqlserver，资源占用较大，推荐使用[bitwarden_rs](https://github.com/dani-garcia/bitwarden_rs)，用ruby实现的bitwarden服务端兼容版本，这就是开源的好处。
密码生成 `openssl rand -base64 48`

```shell
docker pull bitwardenrs/server:latest
docker run -d --name vaultwarden \
  -e SIGNUPS_DOMAINS_WHITELIST=bitget.com \
  -v /data/bw-data/:/data/ \
  -p 127.0.0.1:12345:80 \
  -p 127.0.0.1:3012:3012 \
  vaultwarden/server:latest

```

### 参数配置
```shell
# General Settings
## 设置web访问域名
DOMAIN=https://bitwarden.micorsoft.cn/z/z/bw/

# 是否启用web客户端：true启用，false禁用 , 后期推荐关闭，防止爆破
WEB_VAULT_ENABLED=true

# 是否启用WebSocket通知：true启用，false禁用
WEBSOCKET_ENABLED=true

# 修改线程，默认为20，若用户多可修改为更大，一般默认不需要设置
ROCKET_WORKERS=20

# 显示密码提示：true启用，false禁用
SHOW_PASSWORD_HINT=false

# 启用或禁用邀请：true启用，false禁用
INVITATIONS_ALLOWED=false

# 启用或禁用新用户注册：true启用，false禁用
SIGNUPS_ALLOWED=false

# 注册域名白名单  因用户枚举和批量注册问题，建议关闭
SIGNUPS_DOMAINS_WHITELIST=bitget.com

# 启用或禁用分享发送功能，默认开启，启用true，禁用false
SENDS_ALLOWED=false

# 启用管理后台并设置token，默认为空不启用，设置token后则启用
# 密码生成 `openssl rand -base64 48`
ADMIN_TOKEN=PxArb2LTe+UE70UwhIEmQ+jx7EzYtqMyBp4aOZHgIx+qbDhTS4SR6yFTEDFwuCLl

# 配置SMTP服务
SMTP_PORT=587
SMTP_SSL=true
SMTP_EXPLICIT_TLS=true
SMTP_HOST=smtp.qq.com
SMTP_FROM=741474596@qq.com
SMTP_FROM_NAME=Vaultwarden@BG
SMTP_AUTH_MECHANISM=login
SMTP_USERNAME=741474596@qq.com
SMTP_PASSWORD=gkotyjhergynbdjh1
INVITATION_ORG_NAME=BitGET Limited
_ENABLE_EMAIL_2FA=true
REQUIRE_DEVICE_EMAIL=true

# 设置SQLites数据库存储路径及数据库名
DATABASE_URL=/data/vaultwarden.db

# 设置日志路径
LOG_FILE=data/access.log
LOG_FILE=data/vaultwarden.log

# 日志级别选项：trace、debug、info、warn、error 以及 off
LOG_LEVEL=warn
EXTENDED_LOGGING=true

# 使用CDN时让实例获取访客真实ip
IP_HEADER=X-Forwarded-For

# 时区
TZ=Asia/Shanghai
```



## nginx配置
用nginx实现域名的转发，对于`https://subdomain.domain.com`的请求转发至本地的8080端口，即后续部署的bitwarden服务的端口，nginx的完整配置文件`/etc/nginx/conf.d/subdomain.domain.com`如下:

```yml
# The `upstream` directives ensure that you have a http/1.1 connection
# This enables the keepalive option and better performance
# DOMAIN=https://bitwarden.micorsoft.cn/z/z/bw/
# Define the server IP and ports here.
upstream vaultwarden-default {
  zone vaultwarden-default 64k;
  server 127.0.0.1:8080;
  keepalive 2;
}
upstream vaultwarden-ws {
  zone vaultwarden-ws 64k;
  server 127.0.0.1:3012;
  keepalive 2;
}

# 禁止IP地址访问
server{
    listen 80 default;
    listen 443 default_server;
    server_name _;
    return 501;
    #SSL-START SSL相关配置，请勿删除或修改下一行带注释的404规则
    #error_page 404/404.html;
    ssl_certificate     conf.d/bitwarden.micorsoft.cn.crt;
	  ssl_certificate_key  conf.d/bitwarden.micorsoft.cn.key;
    ssl_session_timeout 5m;
	  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
	  ssl_prefer_server_ciphers on;
    #SSL-END
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name bitwarden.micorsoft.cn;
	##防止搜索引擎收录 
	if ($http_user_agent ~* "qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetcher-Google|Yahoo! Slurp|Yahoo! Slurp China|YoudaoBot|Sosospider|Sogou spider|Sogou web spider|MSNBot|ia_archiver|Tomato Bot|^$") 
	{ return 404; }
	if($scheme = http){
	## 如果使用cf加速就换成302
    return 302 https://$server_name$request_uri;
    }
    
}


server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name bitwarden.micorsoft.cn;
    ##防止搜索引擎收录 
	if ($http_user_agent ~* "qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetcher-Google|Yahoo! Slurp|Yahoo! Slurp China|YoudaoBot|Sosospider|Sogou spider|Sogou web spider|MSNBot|ia_archiver|Tomato Bot|^$") 
	{ return 404; }
	
	#启用HSTS 
	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains;preload" always;
	add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header Referrer-Policy 'strict-origin-when-cross-origin';
    
	ssl_certificate      conf.d/bitwarden.micorsoft.cn.crt;
	ssl_certificate_key  conf.d/bitwarden.micorsoft.cn.key;
	ssl_session_timeout 5m;
	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
	ssl_prefer_server_ciphers on;

	# OCSP stapling 
	ssl_stapling on; 
	ssl_stapling_verify on; 
	##DNS服务器 
	resolver 8.8.8.8;

    client_max_body_size 128M;

	 	 # 隐藏服务，将其他访问全部转发到microsoft上
	 location / {
	   proxy_pass https://www.microsoft.com;
  }

    location /z/z/bw/ {
      proxy_http_version 1.1;
      proxy_set_header "Connection" "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://vaultwarden-default;
    }

    location /z/z/bw/notifications/hub/negotiate {
      proxy_http_version 1.1;
      proxy_set_header "Connection" "";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://vaultwarden-default;
    }

    location /z/z/bw/notifications/hub {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header Forwarded $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_pass http://vaultwarden-ws;
    }

    # Optionally add extra authentication besides the ADMIN_TOKEN
    # Remove the comments below `#` and create the htpasswd_file to have it active
    #
    location /z/z/bw/admin {
    #  # See: https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/
    #  # htpasswd -c /etc/apache2/.htpasswd admin
      auth_basic "Private";
      auth_basic_user_file /etc/apache2/.htpasswd;
    
      proxy_http_version 1.1;
      proxy_set_header "Connection" "";
    
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    
      proxy_pass http://vaultwarden-default;
    }
}

```

# 安全加固
## 防暴力破解
### 安装fail2ban
```shell
apt install fail2ban -y
systemctl enable --now fail2ban
```

### 配置vaultwarden和vaultwarden-admin过滤策略
- vaultwarden-admin
```shell
cat <<EOF > /etc/fail2ban/filter.d/vaultwarden-admin.local
[INCLUDES]
before = common.conf

[Definition]
failregex = ^.*Invalid admin token\. IP: <ADDR>.*$
ignoreregex =
EOF

cat <<EOF > /etc/fail2ban/jail.d/vaultwarden-admin.local
[vaultwarden-admin]
enabled = true
port = 80,443
filter=vaultwarden-admin
banaction = %(banaction_allports)s
logpath = /data/bw-data/vaultwarden.log
maxretry=1
bantime=14400
findtime=14400
EOF

```

- vaultwarden
```bash
cat <<EOF > /etc/fail2ban/filter.d/vaultwarden.local
[INCLUDES]
before = common.conf

[Definition]
#failregex = ^.*Username or password is incorrect\. Try again\. IP: <ADDR>\. Username:.*$
failregex = ^.*Username or password is incorrect\. Try again\. IP: <HOST>\. Username:.*$
ignoreregex=
EOF
```

### 配置vaultwarden和vaultwarden-admin Jail策略
- `vaultwarden-admin` 登录失败1次封停4h
```bash
cat <<EOF > /etc/fail2ban/jail.d/vaultwarden-admin.local
[vaultwarden-admin]
enabled = true
port = 80,443
filter=vaultwarden-admin
banaction = %(banaction_allports)s
logpath = /data/bw-data/vaultwarden.log
maxretry=1
bantime=14400
findtime=14400
EOF
```

- `vaultwarden` 登录失败3次封停4h
```bash
cat <<EOF > /etc/fail2ban/jail.d/vaultwarden.local

[vaultwarden]
enabled=true
port=80,443
filter=vaultwarden
banaction = %(banaction_allports)s
logpath=/data/bw-data/vaultwarden.log
maxretry=3
bantime=14400
findtime=14400
EOF
```


# 数据库定期备份
## 备份脚本
```shell
curl https://rclone.org/install.sh | bash
cat <<EOF >/opt/vaultwarden/backup.sh
#!/bin/bash 
/usr/bin/tar -czvPf /root/.config/up/bitwarden_`date +%Y%m%d%H%M%S`.tar.gz /root/.config/bitwarden /usr/bin/rclone copy /root/.config/up a:data/bitwarden 
/usr/bin/find /root/.config/up -mtime +30 -name "*.tar.gz" -exec rm -rf {} \; 
echo "BACKUP DATE:" $(date +"%Y-%m-%d %H:%M:%S") >> /var/log/backup.log
EOF
```
或者仅备份`db.sqlite3`
```shell
sqlite3 /data/bw-data/db.sqlite3 ".backup '/path/to/backups/db-$(date '+%Y%m%d-%H%M').sqlite3'"
```


## 定期执行
使用 Crontab 每天定时运行备份脚本，假定于每天凌晨 1:00 备份：
```shell
crontab -e

0 1 * * * sh /opt/vaultwarden/backup.sh
```


# Git仓库备份
其实就是新建一个git私有仓库，然后写一个每天打包并自动push到远程仓库的脚本，再配置成定时任务就行了，国内vps推荐使用的gitee，国外的可以用github，

注意！！！ 仓库一定要建成私有的哦 注意！！！
```bash
cd /data && \ 
tar czvf bitwarden_backup_$(date '+%Y%m%d_%H%M').tgz bw-data/ &&  \
mv bitwarden_backup_$(date '+%Y%m%d_%H%M').tgz bitwarden_backup/ && \
cd bitwarden_backup/ && \
git add . && git commit -m 'update' && git push -u origin master
```

⚠️:
- 前提是你的git控制台添加了你本机的公钥
- 你的docker数据卷挂载在了根目录的/data下面，叫bw-data
- 在同级目录新建了一个叫bitwarden_backup的文件夹

如果你满足了上述要求，就可以配置一个如下的定时任务了：
```bash
0 5 * * * bash /data/bitwarden_backup/backup.sh
```
[](https://www.sharpgan.com/media/uploads/2022/02/19/wx20220219-2324092x.png)
为了减少对公共资源的浪费，建议改造一下上述脚本自动删除超过30天的备份。


## [Git仓库备份](https://chengpengzhao.com/2020-08-03-vps-neng-yong-lai-zuo-shi-me/#toc-heading-7)

1. 需要先配置好github环境，用私钥免密码登录github
2. 先建立远程备份仓库并绑定本地仓库
```bash
cd ~/bitwarden/bw-data      #改成自己bitwarden所在位置
git init
git remote add origin git@github.com:xxxx/xxxx.git  #自己在github建的空仓库，这里用SSH进行clone
git add -A
git commit -m "first push"
git push -u origin master
```

3. 建立定时上传github的脚本，备份`bw-data`文件夹
```bash
cd ~
sudo timedatectl set-timezone Asia/Shanghai; #修改系统时区
cat >> backUp_Bitwarden.sh << EOF
#!/bin/sh

date=\$(date '+%Y-%m-%d %H:%M')
cd ~/bitwarden/bw-data
git add -A
git commit -m "backup at $date"
git push
EOF
chmod +x backUp_Bitwarden.sh;
```

4. 定时任务crontab建立
```bash
# 每天13:00备份一次
echo "00 13  * * * bash ~/backUp_Bitwarden.sh> ~/backup.log 2>&1 &">bt.cron;
crontab bt.cron;
rm -rf bt.cron;
crontab -l; #查看是否设置成功
```


# Gmail
```bash
SMTP_PORT=587
SMTP_SSL=true
SMTP_EXPLICIT_TLS=false
SMTP_HOST=smtp.gmail.com
SMTP_FROM=ding.fugui@bitget.com
SMTP_FROM_NAME=Vaultwarden@BG
SMTP_AUTH_MECHANISM=login
SMTP_USERNAME=ding.fugui@bitget.com
SMTP_PASSWORD=plvjucrnfmmdwoyh1
INVITATION_ORG_NAME=BitGET Limited
_ENABLE_EMAIL_2FA=true
REQUIRE_DEVICE_EMAIL=true
```